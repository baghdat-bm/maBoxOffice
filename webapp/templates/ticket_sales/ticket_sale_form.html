{% extends 'base.html' %}
{% load crispy_forms_tags %}
{% load form_filters %}

{% block title %}{% if form.instance.id %}Редактирование{% else %}Создание{% endif %} заказа{% endblock %}

{% block content %}
    <!-- Modals -->
    <div class="modal fade" id="editServiceModal" tabindex="-1" aria-labelledby="editServiceModalLabel"
         aria-hidden="true">
        <div class="modal-dialog modal-xl"> <!-- Изменено на modal-xl для более широкого окна -->
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editServiceModalLabel">Услуга</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"
                            onclick="hideServiceModal();"></button>
                </div>
                <div class="modal-body">
                    <!-- Сюда будет загружена форма с помощью HTMX -->
                    <div id="modal-body-content"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="editPaymentModal" tabindex="-1" aria-labelledby="editPaymentModalLabel"
         aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editPaymentModalLabel">Оплата</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"
                            onclick="hideServiceModal();"></button>
                </div>
                <div class="modal-body">
                    <!-- Сюда будет загружена форма с помощью HTMX -->
                    <div id="modal-payment-body-content"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="container mt-4">
        <h1>{% if form.instance.id %}Редактирование{% else %}Создание{% endif %} заказа</h1>

        <div id="payment-progress-bar" class="progress d-none mt-3">
            <div class="progress-bar progress-bar-striped progress-bar-animated"
                 role="progressbar"
                 style="width: 100%">
                <span id="payment-progress-text">Соединение с терминалом...</span>
            </div>
        </div>

        <form id="ticket-sale-form" method="post">
            {% csrf_token %}
            <!-- Сетка для первой строки с полями date, amount и status -->
            <div class="row">
                <div class="col-md-4">
                    <div class="form-group">
                        {{ form.date.label_tag }}
                        {{ form.date|add_class:"form-control" }}
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-group">
                        {{ form.amount.label_tag }}
                        {{ form.amount|add_class:"form-control" }}
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-group">
                        {{ form.status.label_tag }}
                        {{ form.status|add_class:"form-control" }}
                    </div>
                </div>
            </div>

            <!-- Сетка для новой строки с полями paid_amount и refund_amount -->
            <div class="row mt-3">
                <div class="col-md-6">
                    <div class="form-group">
                        {{ form.paid_amount.label_tag }}
                        {{ form.paid_amount|add_class:"form-control" }}
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        {{ form.refund_amount.label_tag }}
                        {{ form.refund_amount|add_class:"form-control" }}
                    </div>
                </div>
            </div>

            <!-- Сетка для новой строки с полями paid_cash, refund_amount и paid_qr -->
            <div class="row mt-3">
                <div class="col-md-4">
                    <div class="form-group">
                        {{ form.paid_cash.label_tag }}
                        {{ form.paid_cash|add_class:"form-control" }}
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-group">
                        {{ form.paid_card.label_tag }}
                        {{ form.paid_card|add_class:"form-control" }}
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-group">
                        {{ form.paid_qr.label_tag }}
                        {{ form.paid_qr|add_class:"form-control" }}
                    </div>
                </div>
            </div>

            <h2>Услуги</h2>
            <div id="ticket-sales-service-list">
                {% if form.instance.id %}
                    {% include 'ticket_sales/partials/ticket_sales_service_list.html' with ticket_sale=form.instance %}
                {% endif %}
            </div>
            {% if form.instance.id %}
                <button type="button" class="btn btn-secondary mt-2"
                        hx-get="{% url 'ticket_sales:ticket-sales-service-create' form.instance.id %}"
                        {# hx-target="#ticket-sales-service-list" hx-swap="beforeend"#}
                        hx-target="#modal-body-content"
                        hx-trigger="click" data-bs-toggle="modal" data-bs-target="#editServiceModal"
                >
                    Добавить услугу
                </button>
            {% else %}
                Перед добавлением услуги необходимо сохранить заказ
            {% endif %}

            <h2>Платежи</h2>
            <div id="ticket-sales-payments-list">
                {% if form.instance.id %}
                    {% include 'ticket_sales/partials/ticket_sales_payments_list.html' with ticket_sale=form.instance %}
                {% endif %}
            </div>
            {% if form.instance.id %}
                <button type="button" class="btn btn-success mt-2" id="start-payment"
                        data-ticket-sale-id="{{ form.instance.id }}">
                    Выполнить оплату
                </button>

            {% else %}
                Для оплаты необходимо сохранить заказ
            {% endif %}

            <div class="mt-2">
                <button type="submit" class="btn btn-primary">Сохранить и закрыть</button>
                <button type="submit" class="btn btn-secondary" id="save-button">
                    Сохранить
                </button>
                <a href="{% url 'ticket_sales:ticket-sale-list' %}" class="btn btn-secondary">Назад к списку</a>
            </div>
        </form>
    </div>
{% endblock %}


{% block scripts %}
    <script>

        document.getElementById('save-button').addEventListener('click', function (event) {
            event.preventDefault();

            const form = document.getElementById('ticket-sale-form');
            const formData = new FormData(form);

            fetch("{% if form.instance.id %} {% url 'ticket_sales:ticket-sale-update-x' form.instance.id %} {% else %} {% url 'ticket_sales:ticket-sale-create-x' %} {% endif %}",
                {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
                    },
                    body: formData,
                })
                .then(response => response.json())
                .then(data => {
                    if (data.redirect_url) {
                        window.location.href = data.redirect_url;
                    }
                })
                .catch(error => console.error('Ошибка:', error));
        });
        
        function hideServiceModal() {
            window.location.reload();
        }

        if (document.getElementById('start-payment')) {
            document.getElementById('start-payment').addEventListener('click', function () {
                const progressBar = document.getElementById('payment-progress-bar');
                const progressText = document.getElementById('payment-progress-text');

                // Отобразить прогресс-бар
                progressBar.classList.remove('d-none');

                // Отправка данных на терминал
                progressText.textContent = 'Соединение с терминалом...';

                const paymentFormData = new FormData(document.querySelector('form'));

                // Получаем значения из атрибутов данных
                const ticketSaleId = this.getAttribute('data-ticket-sale-id');

                fetch(`/ticket-sales/payment-process/${ticketSaleId}/`, {
                    method: 'POST',
                    body: paymentFormData
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'wait') {
                            progressText.textContent = 'Проводим оплату...';
                            checkPaymentStatus(data.process_id, ticketSaleId);
                        } else {
                            progressText.textContent = 'Ошибка соединения';
                            setTimeout(() => progressBar.classList.add('d-none'), 5000);
                        }
                    })
                    .catch(() => {
                        progressText.textContent = 'Ошибка соединения';
                        setTimeout(() => progressBar.classList.add('d-none'), 5000);
                    });
            })
        }
        ;


        function checkPaymentStatus(processId, ticketSaleId) {
            const progressBar = document.getElementById('payment-progress-bar');
            const progressText = document.getElementById('payment-progress-text');

            fetch(`{% url 'ticket_sales:check-payment-status' process_id='$1' ticket_sale_id='$2' %}`
                .replace('$1', processId)
                .replace('$2', ticketSaleId))
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'wait') {
                        setTimeout(() => checkPaymentStatus(processId, ticketSaleId), 1000);
                    } else if (data.status === 'success') {
                        progressText.textContent = 'Заказ оплачен';
                        setTimeout(() => {
                            progressBar.classList.add('d-none');
                            window.location.reload(); // Полное обновление страницы
                        }, 3000);
                    } else {
                        progressText.textContent = `Ошибка: ${data.error_text || 'Неизвестная ошибка'}`;
                        setTimeout(() => progressBar.classList.add('d-none'), 5000);
                    }
                })
                .catch(() => {
                    progressText.textContent = 'Ошибка проверки статуса';
                    setTimeout(() => progressBar.classList.add('d-none'), 5000);
                });
        }

    </script>

{% endblock %}