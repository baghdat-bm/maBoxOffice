{% load crispy_forms_tags %}
{% load form_filters %}

<form method="post" onsubmit="return closeModal();" hx-post="
        {% if form.instance.id %}{% url 'ticket_sales:ticket-sales-service-update' form.instance.ticket_sale.id form.instance.id %}{% else %}{% url 'ticket_sales:ticket-sales-service-create' ticket_sale.id %}{% endif %}"
      hx-target="#ticket-sales-service-list" hx-swap="innerHTML">
    {% csrf_token %}

    <!-- Первая строка с полями event_date, event, event_time -->
    <div class="row">
        <div class="col-md-4">
            <div class="form-group">
                {{ form.event_date.label_tag }}
                <input type="date" id="id_event_date" name="event_date" class="form-control" required
                       onchange="onEventDateChange(this.value)">
            </div>
        </div>
        <div class="col-md-4">
            <div class="form-group">
                <label for="event">Мероприятие</label>
                <select id="event" name="event" class="form-control" onchange="onEventChange(this.value)" required>
                    <!-- Опции будут динамически добавляться здесь -->
                </select>
            </div>
        </div>
        <div class="col-md-4">
            <div class="form-group">
                <label for="event_time">Время мероприятия</label>
                <select id="event_time" name="event_time" class="form-control" required>
                    <option value="">Выберите время</option>
                    <!-- Этот список будет обновляться с помощью JavaScript -->
                </select>
            </div>
        </div>
    </div>

    <!-- Вторая строка с полями service, tickets_count, tickets_amount -->
    <div class="row mt-3">
        <div class="col-md-4">
            <div class="form-group">
                {{ form.service.label_tag }}
                <select id="id_service" name="service" class="form-control" onchange="onServiceChange()" required>
                    <!-- Вставьте здесь необходимые опции -->
                </select>
            </div>
        </div>

        <div class="col-md-4">
            <div class="form-group">
                {{ form.tickets_count.label_tag }}
                <input type="number" id="id_tickets_count" name="tickets_count" class="form-control"
                       oninput="onTicketsCountChange()" min="1" required>
            </div>
        </div>

        <div class="col-md-4">
            <div class="form-group">
                {{ form.tickets_amount.label_tag }}
                <input type="number" id="id_tickets_amount" name="tickets_amount" class="form-control" readonly>
            </div>
        </div>
    </div>

    <!-- Третья строка с полями discount, total_amount -->
    <div class="row mt-3">
        <div class="col-md-4">
            <div class="form-group">
            </div>
        </div>
        <div class="col-md-4">
            <div class="form-group">
                {{ form.discount.label_tag }}
                <input type="number" id="id_discount" name="discount" class="form-control" oninput="onDiscountChange()">
            </div>
        </div>
        <div class="col-md-4">
            <div class="form-group">
                {{ form.total_amount.label_tag }}
                <input type="number" id="id_total_amount" name="total_amount" class="form-control" readonly>
            </div>
        </div>
    </div>

    <button type="submit" class="btn btn-primary mt-1">
        {% if form.instance.id %}
            Записать
        {% else %}
            Добавить
        {% endif %}
    </button>
</form>

{% block scripts %}
    <script>

        function onServiceChange() {
            updateTicketsAmount(true);
        }

        function onTicketsCountChange() {
            updateTicketsAmount(true);
        }

        function updateTicketsAmount(updateTotalAmountAfterRequest = false) {
            const serviceSelect = document.getElementById('id_service');
            const ticketsCountInput = document.getElementById('id_tickets_count');
            const ticketsAmountInput = document.getElementById('id_tickets_amount');

            const selectedServiceId = serviceSelect.value;
            const ticketsCount = parseInt(ticketsCountInput.value) || 0;

            if (selectedServiceId) {
                const url = `{% url 'ticket_sales:get-service-cost' %}?service_id=${selectedServiceId}`;
                fetch(url)
                    .then(response => response.json())
                    .then(data => {
                        const cost = parseInt(data.cost) || 0;
                        ticketsAmountInput.value = cost * ticketsCount;
                        if (updateTotalAmountAfterRequest)
                            updateTotalAmount();
                    });
            } else {
                ticketsAmountInput.value = 0;
                if (updateTotalAmountAfterRequest)
                    updateTotalAmount();
            }
        }

        function onDiscountChange() {
            updateTotalAmount();
        }

        function updateTotalAmount() {
            const discountInput = document.getElementById('id_discount');
            const ticketsAmountInput = document.getElementById('id_tickets_amount');

            let total_amountInput = document.getElementById('id_total_amount');
            total_amountInput.value = ticketsAmountInput.value - discountInput.value;
        }

        function onEventChange(eventId) {
            updateEventTimeOptions(eventId);
            updateServicesOptions(eventId);            
        }

        function updateEventTimeOptions(eventId) {
            const eventTimeSelect = document.getElementById('event_time');

            if (eventId) {
                const url = new URL("{% url 'ticket_sales:filtered-event-times' %}", window.location.origin);
                url.searchParams.set('event', eventId);

                fetch(url)
                    .then(response => response.json())
                    .then(data => {
                        // Очищаем старые опции
                        eventTimeSelect.innerHTML = '<option value="">Выберите время</option>';
                        // Добавляем новые опции
                        data.times.forEach(time => {
                            const option = document.createElement('option');
                            option.value = time.begin_date;
                            option.textContent = time.begin_date;
                            eventTimeSelect.appendChild(option);
                        });
                    })
                    .catch(error => console.error('Ошибка загрузки времени:', error));
            } else {
                // Если нет выбранного мероприятия, очищаем список времен
                eventTimeSelect.innerHTML = '<option value="">Выберите время</option>';
            }
        }

        function updateServicesOptions(eventId) {
            var serviceSelect = document.getElementById('id_service');

            if (eventId) {
                const url = new URL("{% url 'ticket_sales:filtered-services' %}", window.location.origin);
                url.searchParams.set('event_id', eventId);
                fetch(url)
                    .then(response => response.json())
                    .then(data => {
                        // Очистить старые опции
                        serviceSelect.innerHTML = '<option value="">Выберите услугу</option>';
                        // Добавить новые опции
                        data.forEach(function (service) {
                            var option = document.createElement('option');
                            option.value = service.id;
                            option.text = service.name;
                            serviceSelect.appendChild(option);
                        });
                        
                        updateTicketsAmount(true);
                    });
            } else {
                // Очистить поле выбора услуг, если мероприятие не выбрано
                serviceSelect.innerHTML = '<option value="">Выберите услугу</option>';
                updateTicketsAmount(true);
            }
        }

        function onEventDateChange(date) {

            if (date) {
                const url = `{% url 'ticket_sales:filtered-events' %}?date=${date}`;
                fetch(url)
                    .then(response => response.json())
                    .then(data => {
                        populateEventSelect(data.events);                        
                    })
                    .catch(error => {
                        console.error('Error fetching events:', error);
                        updateTicketsAmount(true);
                    });
            }
            else {
                populateEventSelect([]);                
            }            
        }

        function populateEventSelect(events) {
            const eventSelect = document.getElementById('event');
            eventSelect.innerHTML = ''; // Очистить текущие опции
            if (events.length > 0) {
                events.forEach(event => {
                    const option = document.createElement('option');
                    option.value = event.id;
                    option.textContent = event.name;
                    eventSelect.appendChild(option);
                });

                onEventChange(events[0].id);
            } else {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'Нет доступных мероприятий';
                eventSelect.appendChild(option);
                onEventChange('');
            }
        }

        function closeModal() {
            var modalElement = document.getElementById('editServiceModal');
            var modalInstance = bootstrap.Modal.getInstance(modalElement);

            // Используем setTimeout, чтобы дать время записи сохраниться
            setTimeout(function () {
                window.location.reload();
            }, 100);  // Задержка в 500 мс (можно увеличить, если необходимо больше времени)
            
            modalInstance.hide();

            return false;  // Предотвращаем повторную отправку формы
        }

        (function setDefaultDate() {
            let eventDateInput = document.getElementById('id_event_date');
            if (eventDateInput && !eventDateInput.value) {
                eventDateInput.value = new Date().toISOString().slice(0, 10);
            }

            onEventDateChange(eventDateInput.value);

            let ticketsCountInput = document.getElementById('id_tickets_count');
            if (ticketsCountInput && !ticketsCountInput.value) {
                ticketsCountInput.value = 1;
            }

            let ticketsAmountInput = document.getElementById('id_tickets_amount');
            if (ticketsAmountInput && !ticketsAmountInput.value) {
                ticketsAmountInput.value = 0;
            }

            let discountInput = document.getElementById('id_discount');
            if (discountInput && !discountInput.value) {
                discountInput.value = 0;
            }

            let total_amountInput = document.getElementById('id_total_amount');
            if (total_amountInput && !total_amountInput.value) {
                total_amountInput.value = 0;
            }

        })();

    </script>
{% endblock %}
