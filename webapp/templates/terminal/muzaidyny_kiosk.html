{% load static %}

<!DOCTYPE html>
<html lang="ru">
<link type="text/css" rel="stylesheet" id="dark-mode-custom-link">
<link type="text/css" rel="stylesheet" id="dark-mode-general-link">
<style lang="en" type="text/css" id="dark-mode-custom-style"></style>
<style lang="en" type="text/css" id="dark-mode-native-style"></style>
<style lang="en" type="text/css" id="dark-mode-native-sheet"></style>
<head>
    <meta charset="viewport" content="width=device-width, initial-scale=1.0">
    <title>Киоск Ледовый Дворец</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        body {
            background-color: #f0f2f5;
            color: #000;
            height: 100vh;
            width: 1080px;
            margin: 0;
            display: flex;
            flex-direction: column;
            font-size: 22px;
            overflow: hidden;
        }

        .header {
            background-color: #2c2c2c;
            color: white;
            padding: 20px 0;
            height: 100px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 10;
        }

        .container-header {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-left: 20px;
            padding-right: 20px;
        }

        .current-time {
            font-size: 20px;
            font-weight: 500;
            color: #e0e7ff;
            text-align: left;
        }

        .logo {
            width: 150px;
            margin-left: auto;
            margin-right: auto;
        }

        .language-buttons {
            display: flex;
            gap: 20px;
        }


        .language-buttons .btn {
            padding: 10px 20px;
            font-size: 18px;
            background-color: transparent;
            color: #e0e7ff;
            border: 1px solid #e0e7ff;
            border-radius: 0;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .language-buttons .btn:hover {
            background-color: #e0e7ff;
            color: #2c2c2c;
        }

        /* Хедер */
        .header {
            background-color: #2c2c2c;
            color: white;
            padding: 20px 0;
            height: 100px;
            display: flex;
            justify-content: center; /* Центрируем по горизонтали */
            align-items: center;
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 10;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        /* Логотип по центру */
        .logo {
            width: 150px;
            position: relative;
            z-index: 1;
        }

        /* Стили для времени и выбора языка */
        .container-header {
            position: relative;
            width: 100%;
        }

        /* Элементы по бокам */
        .current-time,
        .language-buttons {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
        }

        .current-time {
            left: 20px; /* Слева */
        }

        .language-buttons {
            right: 20px; /* Справа */
            display: flex;
            gap: 20px;
        }

        .language-buttons .btn {
            padding: 10px 20px;
            font-size: 18px;
            background-color: transparent;
            color: #e0e7ff;
            border: 1px solid #e0e7ff;
            border-radius: 0;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .language-buttons .btn:hover {
            background-color: #e0e7ff;
            color: #2c2c2c;
        }

        /* Основной блок */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding-top: 120px;
            padding-bottom: 100px;
            overflow-y: auto;
            padding-left: 20px;
            padding-right: 20px;
        }

        .block-divider {
            margin-bottom: 30px;
        }

        /* Заголовки блоков */
        h3 {
            margin-bottom: 15px;
            font-weight: bold;
            font-size: 24px;
            color: #333;
        }

        /* Убираем padding и margin для .container только в блоке выбора даты */
        .container.date-picker-wrapper {
            padding: 0 !important;
            margin: 0 auto; /* Центрируем блок */
            max-width: 1080px; /* Фиксируем ширину, как в хедере и футере */
            width: 100%; /* Полная ширина */
        }

        .date-picker-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%; /* Полная ширина */
            padding: 0;
        }

        .date-picker-items {
            display: flex;
            justify-content: space-between;
            width: 100%;
            overflow: hidden;
            position: relative;
        }

        .date-picker-item {
            flex-grow: 1;
            padding: 20px;
            background-color: #1877f2;
            color: white;
            text-align: center;
            font-size: 22px;
            cursor: pointer;
            transition: background-color 0.3s;
            margin: 0 5px; /* Уменьшенные отступы для равномерного распределения */
            height: 100px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .arrow-button {
            font-size: 30px;
            background-color: transparent;
            border: none;
            color: #1877f2;
            cursor: pointer;
            transition: color 0.3s;
            width: 50px; /* Фиксированная ширина кнопок */
        }

        .arrow-button:hover {
            color: #0c5ab9;
        }

        .date-picker-items {
            display: flex;
            justify-content: space-between;
            width: 95%;
            overflow: hidden;
            position: relative;
            transition: transform 0.5s ease;
        }

        .date-picker-item {
            flex-grow: 1;
            padding: 20px;
            background-color: #1877f2;
            color: white;
            text-align: center;
            font-size: 22px;
            cursor: pointer;
            transition: background-color 0.3s;
            margin: 0 10px;
            height: 100px;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 0;
        }

        .date-picker-item.disabled {
            background-color: #999;
            cursor: not-allowed;
        }

        .date-picker-item:hover:not(.disabled) {
            /*background-color: #165eac;*/
        }

        .date-picker-item.selected {
            background-color: #28a745;
        }

        /* Карточки для выбора сеанса */
        .session-card-container {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            max-height: 300px;
        }

        .session-card {
            background-color: #1877f2;
            color: white;
            padding: 20px;
            text-align: center;
            font-size: 24px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            border-radius: 0;
            width: 18%; /* Одинаковая ширина для карточек */
            height: 100px; /* Одинаковая высота для карточек */
            margin: 10px 0;
        }

        .session-card.disabled {
            background-color: #999;
            cursor: not-allowed;
        }

        .session-card:hover:not(.disabled) {
        }

        .session-card.selected {
            background-color: #28a745;
        }

        /* Блок выбора услуги */
        .service-block {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%; /* Полная ширина */
            padding: 0;
        }

        #serviceSelect {
            flex-grow: 5; /* Растягиваем селектор услуги на 5 частей */
        }

        #quantity {
            flex-grow: 1; /* Селектор количества уменьшен в 3 раза */
        }

        #addTicketBtn {
            flex-grow: 1; /* Кнопка добавления билета остается на 1 части */
        }

        .service-block select,
        .service-block input,
        .service-block button {
            margin-right: 20px;
            font-size: 22px;
            border-radius: 0;
        }

        .service-block select {
            width: 60%;
            height: 60px;
        }

        .service-block select#quantity {
            width: 20%;
            height: 60px;
        }

        .service-block button {
            width: 20%;
            height: 60px;
        }

        /* Убираем padding и margin для контейнера */
        .container.ticket-wrapper {
            padding: 0 !important;
            margin: 0 auto; /* Центрируем блок */
            max-width: 1080px; /* Фиксируем ширину, как в хедере и футере */
            width: 100%; /* Полная ширина */
        }

        .ticket-table {
            width: 100%;
            position: relative;
            border-collapse: collapse;
            table-layout: fixed; /* Устанавливаем фиксированную ширину для всех колонок */
        }

        .ticket-table thead, .ticket-table tbody {
            display: table;
            width: 100%;
            table-layout: fixed; /* Совпадение ширины столбцов */
        }

        .ticket-table thead th,
        .ticket-table tbody td {
            padding: 15px;
            text-align: center;
            font-size: 20px;
            border-bottom: 1px solid #ddd;
        }

        .ticket-table thead {
            background-color: #2c2c2c;
            color: white;
        }

        .ticket-table thead th:nth-child(2),
        .ticket-table tbody td:nth-child(2) {
            width: 50%; /* Колонка "Услуга" занимает 50% ширины */
        }

        .ticket-table thead th:nth-child(3),
        .ticket-table tbody td:nth-child(3),
        .ticket-table thead th:nth-child(4),
        .ticket-table tbody td:nth-child(4) {
            width: 15%; /* Колонки "Кол-во" и "Сумма" занимают по 15% */
        }

        .ticket-table thead th:nth-child(5),
        .ticket-table tbody td:nth-child(5) {
            width: 10%; /* Колонка для кнопки удаления занимает 10% */
        }

        .ticket-table thead th {
            padding: 15px;
            text-align: center;
            font-size: 20px;
            border-bottom: 1px solid #ddd;
            vertical-align: middle; /* Вертикальное выравнивание по центру */
            height: 60px; /* Увеличиваем высоту для лучшего вертикального центрирования, если нужно */
        }

        .ticket-footer {
            background-color: #2c2c2c;
            color: white;
            padding: 15px;
            text-align: right;
            font-weight: bold;
            font-size: 22px;
            position: sticky; /* Фиксируем футер */
            bottom: 0;
            width: 100%;
            box-sizing: border-box;
            z-index: 1; /* Устанавливаем приоритет над прокручиваемыми элементами */
        }

        .ticket-table {
            width: 100%;
            position: relative;
            border-collapse: collapse;
            table-layout: fixed;
        }

        .ticket-table tbody {
            display: block;
            overflow-y: auto;
            max-height: 400px; /* Ограничиваем высоту таблицы для скролла */
        }


        .ticket-table {
            width: 100%;
            position: relative;
            border-collapse: collapse;
            table-layout: fixed; /* Фиксированная ширина для всех колонок */
        }

        .ticket-table tbody {
            display: block;
            overflow-y: auto;
            max-height: 600px; /* Увеличиваем высоту в 1.5 раза */
        }

        .ticket-table thead th,
        .ticket-table tbody td {
            padding: 15px;
            text-align: center;
            font-size: 20px;
            border-bottom: 1px solid #ddd;
        }

        /* Колонка "Дата и время" */
        .ticket-table thead th:nth-child(1),
        .ticket-table tbody td:nth-child(1) {
            width: 15%; /* 15% ширины */
        }

        /* Колонка "Услуга" */
        .ticket-table thead th:nth-child(2),
        .ticket-table tbody td:nth-child(2) {
            width: 55%; /* 55% ширины */
        }

        /* Колонки "Кол-во", "Сумма" и "Удаление" */
        .ticket-table thead th:nth-child(3),
        .ticket-table tbody td:nth-child(3),
        .ticket-table thead th:nth-child(4),
        .ticket-table tbody td:nth-child(4),
        .ticket-table thead th:nth-child(5),
        .ticket-table tbody td:nth-child(5) {
            width: 10%; /* По 10% ширины */
        }

        /* Фиксированный футер таблицы */
        .ticket-footer {
            background-color: #2c2c2c;
            color: white;
            padding: 15px;
            text-align: right;
            font-weight: bold;
            font-size: 22px;
            position: sticky;
            bottom: 0;
            width: 100%;
            box-sizing: border-box;
            z-index: 1;
        }

        /* Футер */
        /* Растягиваем фон футера на всю ширину браузера */
        .footer {
            background-color: #2c2c2c;
            color: white;
            padding: 15px 0;
            width: 100%; /* Фон футера растянут на всю ширину */
            position: fixed;
            bottom: 0;
            left: 0;
            z-index: 10;
        }

        /* Контейнер для содержимого футера, выравниваем по ширине как другие блоки */
        .footer-content {
            max-width: 1080px; /* Ширина как у остальных блоков */
            margin: 0 auto; /* Центрируем содержимое */
            display: flex;
            justify-content: space-between;
            padding-left: 15px;
            padding-right: 15px;
        }

        .footer-content .btn {
            padding: 10px 30px;
            font-size: 22px;
        }

        .footer .btn {
            padding: 10px 30px;
            font-size: 22px;
        }

        .footer .btn-primary {
            background-color: #28a745;
            border: none;
            color: white;
            width: 20%;
            height: 60px;
        }

        .footer .btn-danger {
            background-color: #dc3545;
            border: none;
            color: white;
            width: 15%;
        }

        /* Модальное окно */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 4px;
            text-align: center;
            width: 400px;
        }

        .modal-content button {
            margin: 10px;
        }

        .show {
            display: flex !important;
        }

        /* Блок выбора даты */
        .container.date-picker-wrapper {
            padding: 0 !important;
            margin: 0 !important;
            width: 100%;
        }

        /* Блок выбора сеанса */
        .container.session-wrapper {
            padding: 0 !important;
            margin: 0 auto; /* Центрирование */
            max-width: 1080px; /* Фиксируем ширину, как в хедере и футере */
            width: 100%; /* Полная ширина */
        }

        .session-card-container {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            width: 100%; /* Полная ширина */
            padding: 0;
        }

        .session-card {
            flex-grow: 1;
            background-color: #1877f2;
            color: white;
            padding: 20px;
            text-align: center;
            font-size: 22px;
            cursor: pointer;
            transition: background-color 0.3s;
            margin: 10px 5px; /* Уменьшенные отступы */
            height: 100px;
            display: flex;
            flex-direction: column; /* Включаем вертикальное расположение */
            justify-content: center;
            align-items: center;
            width: calc(20% - 10px); /* Устанавливаем фиксированную ширину для 5 карточек в строке */
        }

        .session-card .session-time {
            font-size: 22px; /* Время будет крупнее */
            margin-bottom: 10px; /* Отступ от количества билетов */
        }

        .session-card .ticket-quantity {
            font-size: 18px; /* Количество билетов будет чуть меньше */
        }

        .session-card.disabled {
            background-color: #999;
            cursor: not-allowed;
        }

        .session-card.selected {
            background-color: #28a745;
        }

        /* Блок выбора услуги */
        .container.service-wrapper {
            padding: 0 !important;
            margin: 0 auto; /* Центрируем блок */
            max-width: 1080px; /* Фиксируем ширину, как в хедере и футере */
            width: 100%; /* Полная ширина */
        }

        .service-block {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%; /* Полная ширина */
            padding: 0;
        }

        .service-block select,
        .service-block button {
            font-size: 22px;
            padding: 15px;
            margin-right: 20px;
        }

        /* Блок Ваши билеты */
        .container.ticket-wrapper {
            padding: 0 !important;
            margin: 0 !important;
            width: 100%;
        }

        .divider {
            border-top: 2px solid #ccc;
            margin: 20px 0; /* Отступы для разделителя */
            width: 100%;
        }

        /* Ссылка на правила */
        .rules-link {
            font-size: 18px;
            color: #1877f2;
            text-decoration: underline;
            cursor: pointer;
            padding: 10px;
        }

        .rules-link:hover {
            color: #0c5ab9;
        }

        /* Стили для модального окна */
        .modal {
            display: none; /* Скрываем модальное окно по умолчанию */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            max-width: 600px;
            width: 100%;
            text-align: center;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .close {
            position: absolute;
            top: 10px;
            right: 20px;
            font-size: 24px;
            cursor: pointer;
        }

        /* Контейнер для кнопок */
        .modal-buttons {
            display: flex;
            justify-content: space-between;
            gap: 20px; /* Расстояние между кнопками */
            margin-top: 20px;
        }

        /* Кнопки должны занимать равное пространство */
        .modal-buttons button {
            flex-grow: 1;
            padding: 10px;
        }

        .date-picker-items {
            display: flex;
            justify-content: space-between;
            width: 100%;
            transition: transform 0.3s ease; /* Плавное перемещение при свайпе */
        }

        .date-picker-items.swipe-left {
            transform: translateX(-100%); /* Сдвиг влево на 100% */
        }

        .date-picker-items.swipe-right {
            transform: translateX(100%); /* Сдвиг вправо на 100% */
        }
    </style>
</head>
<body>

<!-- Шапка -->
<div class="header">
    <div class="container-header">
        <div class="current-time">
            <span id="currentDate">вторник, 24 сентября 2024 г.</span><br>
            <span id="currentTime">10:39</span>
        </div>

        <img src="{% static '/images/logo_terminal.png' %}" alt="МУЗ Айдыны" class="logo">

        <div class="language-buttons">
            <button class="btn btn-light">Қазақша</button>
            <button class="btn btn-light">Русский</button>
        </div>
    </div>
</div>

<!-- Контент -->
<div class="main-content">
    <!-- Блок выбора даты -->
    <div class="container date-picker-wrapper block-divider">
        <h3>Выберите дату</h3>
        <div class="date-picker-container">
            <button class="arrow-button" onclick="changeWeek(-1)">❮</button>
            <div id="datePickerContainer" class="date-picker-items">
            </div>
            <button class="arrow-button" onclick="changeWeek(1)">❯</button>
        </div>
    </div>

    <!-- Блок выбора сеанса -->
    <div class="container session-wrapper block-divider mt-3">
        <h3>Выберите время сеанса</h3>
        <div class="session-card-container" id="sessionCards">
        </div>
    </div>

    <!-- Блок выбора услуги -->
    <div class="container service-wrapper block-divider">
        <h3>Выберите услугу</h3>
        <div class="service-block">
            <select class="form-control" id="serviceSelect">
                <option value="">Выберите время сеанса</option>
            </select>
            <select class="form-control" id="quantity">
            </select>
            <button class="btn btn-success" id="addTicketBtn">Добавить</button>
        </div>
    </div>

    <!-- Линия для разделения -->
    <div class="divider"></div>

    <!-- Таблица билетов -->
    <div class="container ticket-wrapper block-divider">
        <h3>Ваши билеты</h3>
        <div class="ticket-table scrollable-table">
            <table class="table" id="ticketList">
                <thead>
                <tr>
                    <th>Дата и время</th>
                    <th>Услуга</th>
                    <th>Кол-во</th>
                    <th>Сумма</th>
                    <th></th>
                </tr>
                </thead>
                <tbody>
                <tr>
                </tr>
                </tbody>
            </table>
            <!-- Футер таблицы билетов -->
            <div class="ticket-footer">
                Итого к оплате: <span id="totalAmount">1200 теңге</span>
            </div>
        </div>
    </div>
    <!-- Футер -->
    <div class="footer">
        <div class="footer-content">
            <button class="btn btn-danger">Отменить</button>

            <!-- Ссылка на правила покупки билетов -->
            <a href="#" id="openRulesModal" class="rules-link">Правила покупки билетов</a>

            <button class="btn btn-primary">Оплатить</button>
        </div>
    </div>

    <!-- Модальное окно для правил покупки билетов -->
    <div id="rulesModal" class="modal">
        <div class="modal-content">
            <span class="close" id="closeRulesModal">×</span>
            <h2>Правила покупки билетов</h2>
            <p>
                Здесь будут написаны все правила покупки билетов. Вы можете подробно
                расписать все условия, возвраты, правила поведения, и прочее.
            </p>
        </div>
    </div>

    <!-- Модальное окно для подтверждения удаления билета -->
    <div id="deleteModal" class="modal">
        <div class="modal-content">
            <p>Вы действительно хотите удалить выбранный билет?</p>
            <div class="modal-buttons">
                <button id="confirmDelete" class="btn btn-danger">Да</button>
                <button id="cancelDelete" class="btn btn-secondary">Нет</button>
            </div>
        </div>
    </div>

    <!-- Модальное окно для предупреждения о выборе сеанса -->
    <div id="warningModal" class="modal">
        <div class="modal-content">
            <p>Выберите сеанс перед добавлением билета</p>
            <button class="btn btn-primary" onclick="closeWarningModal()">OK</button>
        </div>
    </div>

    <script>

        let tickets = [];
        let totalAmount = 0;
        let isSessionSelected = false;
        let selectedDate = null;
        let selectedEventId = null;
        let selectedBeginTime = null;
        let selectedEndTime = null;
        let ticketToRemove = null;
        let weekOffset = 0; // Сохранение смещения по неделям
        ////
        let startX = 0;
        let currentX = 0;
        let isSwiping = false;
        const datePickerItems = document.querySelector('.date-picker-items');

        // Генерация блока выбора даты с данными с сервера
        function generateDatePicker() {
            const datePickerContainer = document.getElementById('datePickerContainer');
            datePickerContainer.innerHTML = ""; // Очищаем предыдущие дни

            // Получаем доступные даты с сервера
            fetch("{% url 'ticket_sales:get-events-dates' %}")
                .then(response => response.json())
                .then(data => {
                    const availableDates = data.available_dates; // Массив доступных дат

                    const today = new Date();
                    const maxDate = new Date(today);
                    maxDate.setDate(today.getDate() + 30); // Ограничение до 30 дней

                    let currentDate = new Date(today);
                    currentDate.setDate(currentDate.getDate() + weekOffset); // Добавляем смещение недели

                    const dayOfWeek = currentDate.getDay();
                    const offset = (dayOfWeek === 0) ? -6 : 1 - dayOfWeek;
                    currentDate.setDate(currentDate.getDate() + offset);

                    for (let i = 0; i < 7; i++) {
                        const formattedDate = currentDate.toISOString().slice(0, 10); // Форматируем дату

                        const day = currentDate.toLocaleDateString('ru-RU', {weekday: 'short', day: 'numeric', month: 'short'});
                        const dateElement = document.createElement('div');
                        dateElement.classList.add('date-picker-item');
                        dateElement.textContent = day;
                        dateElement.dataset.date = formattedDate;

                        // Проверка на доступность даты
                        if (!availableDates.includes(formattedDate)) {
                            dateElement.classList.add('disabled');
                        } else {
                            dateElement.addEventListener('click', function () {
                                if (!this.classList.contains('disabled')) {
                                    document.querySelectorAll('.date-picker-item').forEach(item => item.classList.remove('selected'));
                                    this.classList.add('selected');
                                    generateSessions(this.dataset.date); // Генерация сеансов для выбранной даты
                                }
                                isSessionSelected = false;
                            });
                        }

                        if (formattedDate === selectedDate) {
                            dateElement.classList.add('selected');
                        }

                        datePickerContainer.appendChild(dateElement);
                        currentDate.setDate(currentDate.getDate() + 1);
                    }

                    // Автовыбор первой доступной даты
                    if (!selectedDate) {
                        const firstAvailableDate = document.querySelector('.date-picker-item:not(.disabled)');
                        if (firstAvailableDate) {
                            firstAvailableDate.classList.add('selected');
                            selectedDate = firstAvailableDate.dataset.date;
                            generateSessions(firstAvailableDate.dataset.date);
                        }
                    }
                })
                .catch(error => {
                    console.error('Ошибка при получении данных с сервера:', error);
                });
        }

        // Кнопка для смены недели
        function changeWeek(direction) {
            weekOffset += direction * 7; // Смещение на 7 дней
            generateDatePicker(); // Перегенерируем даты
        }

        // Генерация сеансов на основе выбранной даты и события
        function generateSessions(date) {
            selectedDate = date;
            const sessionCardContainer = document.querySelector("#sessionCards");
            sessionCardContainer.innerHTML = ""; // Очищаем предыдущие сеансы

            const url = `{% url 'ticket_sales:get-events' %}?date=${date}`;

            fetch(url)
                .then(response => response.json())
                .then(data => {

                    // Проверка, что есть события с сеансами
                    if (!data || !data.events || data.events.length === 0) {
                        console.error("Нет доступных мероприятий или сеансов.");
                        const noSessionsCard = `
                          <div class="session-card disabled" data-time="none">
                            <div>Нет доступных сеансов</div>
                          </div>
                        `;
                        sessionCardContainer.innerHTML += noSessionsCard;
                        return;
                    }

                    let sessionsFound = false;

                    // Обрабатываем каждый event и его seances
                    data.events.forEach(event => {
                        event.times.forEach(time => {
                            const isDisabled = time.quantity === 0;
                            const card = `
                              <div class="session-card ${isDisabled ? 'disabled' : ''}" data-time="${time.begin_date}"
                                data-event-id="${event.id}" data-tickets-quantity="${time.quantity}"
                                data-end-time="${time.end_date}">
                                <div>${time.begin_date}</div>
                                <div>${time.quantity} билетов</div>
                              </div>
                            `;
                            sessionCardContainer.innerHTML += card;
                            sessionsFound = true;
                        });
                    });

                    if (!sessionsFound) {
                        const noSessionsCard = `
                          <div class="session-card disabled" data-time="none">
                            <div>Нет доступных сеансов</div>
                          </div>
                        `;
                        sessionCardContainer.innerHTML += noSessionsCard;
                    }

                    // Интерактивный выбор сеансов
                    document.querySelectorAll('.session-card').forEach((card) => {
                        if (!card.classList.contains('disabled')) {
                            card.addEventListener('click', function () {
                                document.querySelectorAll('.session-card').forEach(card => card.classList.remove('selected'));
                                this.classList.add('selected');
                                isSessionSelected = true;

                                // Извлечение eventId из атрибута data-event-id и вызов updateServiceOptions
                                selectedEventId = this.getAttribute('data-event-id');
                                selectedBeginTime = this.getAttribute('data-time');
                                selectedEndTime = this.getAttribute('data-end-time');
                                updateServiceOptions(selectedEventId, selectedEndTime);

                                const ticketsCount = this.getAttribute('data-tickets-quantity');
                                updateQuantityOptions(ticketsCount);
                            });
                        }
                    });
                })
                .catch(error => {
                    console.error('Ошибка при получении сеансов с сервера:', error);
                    const errorCard = `
                      <div class="session-card disabled" data-time="none">
                        <div>Ошибка загрузки сеансов</div>
                      </div>
                    `;
                    sessionCardContainer.innerHTML += errorCard;
                });
        }

        // функция для заполнения блока выбора услуг
        function updateServiceOptions(eventId, endDate) {
            selectedEventId = eventId;
            selectedEndTime = endDate;
            var serviceSelect = document.getElementById('serviceSelect'); // Изменяем на ваш ID

            if (eventId) {
                const url = new URL("{% url 'ticket_sales:filtered-services' %}", window.location.origin);
                url.searchParams.set('event_id', eventId);

                fetch(url)
                    .then(response => response.json())
                    .then(data => {
                        // Очистить старые опции
                        serviceSelect.innerHTML = ''; // Очищаем все старые опции

                        // Добавить новые опции на основе полученных данных
                        data.forEach(function (service) {
                            var option = document.createElement('option');
                            option.value = service.id;
                            option.text = `${service.name} - ${service.price} теңге`; // Добавляем цену в текст
                            option.setAttribute('data-end-date', endDate);
                            option.setAttribute('data-price', service.price);
                            serviceSelect.appendChild(option);
                        });
                    })
                    .catch(error => {
                        console.error('Ошибка при получении услуг с сервера:', error);
                    });
            } else {
                // Если мероприятие не выбрано, очищаем поле выбора услуг
                serviceSelect.innerHTML = '<option value="">Выберите время сеанса</option>';
            }
        }

        // функция для заполнения блока выбора количества билета
        function updateQuantityOptions(ticketsCount) {
            var quantitySelect = document.getElementById('quantity'); // Изменяем на ваш ID

            // Очистить старые опции
            quantitySelect.innerHTML = ''; // Очищаем все старые опции

            // Добавить новые опции
            for (let i = 1; i <= ticketsCount; i++) {
                let option = document.createElement('option');
                option.value = i.toString();
                option.text = i.toString();
                quantitySelect.appendChild(option);
            }
        }

        // Функция обновления списка билетов
        function updateTicketList() {
            const ticketList = document.getElementById('ticketList').querySelector('tbody');
            ticketList.innerHTML = '';

            tickets.forEach((ticket, index) => {
                const row = `
                  <tr>
                    <td>${formatDate(ticket.date)} ${ticket.timeBegin}</td>
                    <td>${ticket.service}</td>
                    <td>${ticket.quantity}</td>
                    <td>${ticket.total} теңге</td> <!-- Добавляем "теңге" только один раз -->
                    <td><button class="btn btn-danger" onclick="confirmDeleteTicket(${index})">Удалить</button></td>
                  </tr>
                `;
                ticketList.innerHTML += row;
            });

            document.getElementById('totalAmount').innerText = totalAmount + ' теңге'; // "теңге" только один раз

            updateFooterPosition(); // Убедимся, что футер корректно позиционирован
        }

        function updateFooterPosition() {
            const ticketTable = document.querySelector('.scrollable-table');
            const footer = document.querySelector('.ticket-footer');
            const maxScrollTop = ticketTable.scrollHeight - ticketTable.clientHeight;

            if (ticketTable.scrollTop >= maxScrollTop) {
                footer.style.position = 'relative';
            } else {
                footer.style.position = 'sticky';
                footer.style.bottom = '0';
            }
        }


        // Форматирование даты в формате DD-MM-YYYY
        function formatDate(date) {
            const d = new Date(date);
            const day = String(d.getDate()).padStart(2, '0');
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const year = d.getFullYear();
            return `${day}-${month}-${year}`;
        }

        // Функция удаления билета с подтверждением через модальное окно
        function confirmDeleteTicket(index) {
            ticketToRemove = index;
            document.getElementById('deleteModal').classList.add('show');
        }

        function removeTicket(index) {
            totalAmount -= tickets[index].total;
            tickets.splice(index, 1);
            updateTicketList();
            updateFooterPosition();
        }


        // Закрыть модальное окно предупреждения
        function closeWarningModal() {
            document.getElementById('warningModal').classList.remove('show');
        }

        // Инициализация блока выбора даты
        generateDatePicker();

        // Установка текущей даты и времени в шапку
        function updateDateTime() {
            const now = new Date();
            const options = {weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'};
            document.getElementById('currentDate').textContent = now.toLocaleDateString('ru-RU', options);
            document.getElementById('currentTime').textContent = now.toLocaleTimeString('ru-RU', {
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        setInterval(updateDateTime, 1000); // Обновляем время каждую минуту

        // Функция для получения CSRF-токена из кукисов (если используется CSRF)
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        function createSalesBooking(serviceId, eventId, eventDate, eventTime, eventTimeEnd, ticketsCount, ticketsAmount)
        {
            // Создаем объект данных для отправки
            var bookingData = {
                service_id: serviceId,
                event_id: eventId,
                event_date: eventDate,
                event_time: eventTime,
                event_time_end: eventTimeEnd,
                tickets_count: ticketsCount,
                tickets_amount: ticketsAmount,
                discount: 0,
                total_amount: ticketsAmount
            };

            // Отправляем данные через fetch
            fetch("{% url 'ticket_sales:booking_create' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken') // защита CSRF
                },
                body: JSON.stringify(bookingData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'created') {
                    console.log('Бронирование успешно создано! ID: ' + data.id);
                    return data.id;
                } else {
                    console.error('Ошибка создания бронирования: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Ошибка при отправке данных:', error);
            });
            return null;
        }

        // Добавление билетов
        document.getElementById('addTicketBtn').addEventListener('click', () => {
            // Проверяем, выбран ли сеанс
            if (!isSessionSelected) {
                document.getElementById('warningModal').classList.add('show');
                return;
            }

            // Получаем данные выбранной даты, услуги, количества и времени
            const date = document.querySelector('.date-picker-item.selected').dataset.date;
            const service = document.getElementById('serviceSelect').selectedOptions[0].text;
            const serviceId = parseInt(document.getElementById('serviceSelect').value);
            const quantity = parseInt(document.getElementById('quantity').value);
            const time = document.querySelector('.session-card.selected').dataset.time;

            const serviceSelect = document.getElementById('serviceSelect');
            const selectedOption = serviceSelect.options[serviceSelect.selectedIndex];
            const price = parseInt(selectedOption.getAttribute('data-price'));

            console.log('selectedDate', selectedDate);
            console.log('selectedBeginTime', selectedBeginTime);
            console.log('selectedEndTime', selectedEndTime);
            console.log('selectedEventId', selectedEventId);
            console.log('serviceId', serviceId);
            console.log('price', price);

            const idBooking = createSalesBooking(serviceId, selectedEventId, selectedDate, selectedBeginTime,
                selectedEndTime, quantity, quantity * price);

            // Проверяем, существует ли уже билет с такими же характеристиками
            const existingTicket = false; // tickets.find(ticket => ticket.date === selectedDate
                {#&& ticket.eventId === selectedEventId    #}
                {#&& ticket.timeBegin === selectedBeginTime #}
                {#&& ticket.serviceId === serviceId);#}

            if (existingTicket) {
                // Обновляем количество и сумму для существующего билета
                existingTicket.quantity += quantity;
                existingTicket.total = quantity * price;
            } else {
                // Создаем новый билет и добавляем в массив
                const ticket = {
                    idBooking,
                    date: selectedDate,
                    timeBegin: selectedBeginTime,
                    endTime: selectedEndTime,
                    eventId: selectedEventId,
                    serviceId,
                    service,
                    quantity,
                    price,
                    total: quantity * price
                };
                tickets.push(ticket);
            }

            // Обновляем общую сумму
            totalAmount = tickets.reduce((sum, ticket) => sum + ticket.total, 0);

            // Обновляем таблицу с билетами
            updateTicketList();
            //updateFooterPosition(); // Обновляем позицию футера
        });

        // Вызываем обновление при изменении размеров окна и прокрутке
        window.addEventListener('scroll', updateFooterPosition);
        window.addEventListener('resize', updateFooterPosition);
        window.addEventListener('load', updateFooterPosition);
        document.getElementById('confirmDelete').addEventListener('click', () => {
            document.getElementById('deleteModal').classList.remove('show');
            removeTicket(ticketToRemove);
        });
        document.getElementById('cancelDelete').addEventListener('click', () => {
            document.getElementById('deleteModal').classList.remove('show');
        });

        // Открытие модального окна
        document.getElementById('openRulesModal').addEventListener('click', function (event) {
            event.preventDefault();
            document.getElementById('rulesModal').style.display = 'flex'; // Показываем модальное окно
        });

        // Закрытие модального окна
        document.getElementById('closeRulesModal').addEventListener('click', function () {
            document.getElementById('rulesModal').style.display = 'none'; // Скрываем модальное окно
        });

        // Закрытие модального окна при клике вне его
        window.addEventListener('click', function (event) {
            const modal = document.getElementById('rulesModal');
            if (event.target === modal) {
                modal.style.display = 'none'; // Скрываем модальное окно при клике вне него
            }
        });


        // Обработчик начала касания
        document.querySelector('.date-picker-container').addEventListener('touchstart', (e) => {
            startX = e.touches[0].clientX;
            isSwiping = true;
            datePickerItems.style.transition = 'none'; // Отключаем анимацию при начале касания
        });

        // Обработчик движения пальца
        document.querySelector('.date-picker-container').addEventListener('touchmove', (e) => {
            if (!isSwiping) return;

            currentX = e.touches[0].clientX;
            const deltaX = currentX - startX;

            // Двигаем блок дат в зависимости от перемещения пальца
            datePickerItems.style.transform = `translateX(${deltaX}px)`;
        });

        // Обработчик окончания касания
        document.querySelector('.date-picker-container').addEventListener('touchend', (e) => {
            isSwiping = false;
            const endX = e.changedTouches[0].clientX;
            const deltaX = endX - startX;

            // Определяем направление свайпа
            if (deltaX > 50) {
                // Свайп вправо — переход на предыдущую неделю
                datePickerItems.style.transition = 'transform 0.3s ease';
                datePickerItems.style.transform = 'translateX(100%)'; // Плавное движение вправо
                setTimeout(() => {
                    changeWeek(-1); // Переход на предыдущую неделю
                    datePickerItems.style.transform = 'translateX(0)'; // Возвращаем блок на место
                }, 300);
            } else if (deltaX < -50) {
                // Свайп влево — переход на следующую неделю
                datePickerItems.style.transition = 'transform 0.3s ease';
                datePickerItems.style.transform = 'translateX(-100%)'; // Плавное движение влево
                setTimeout(() => {
                    changeWeek(1); // Переход на следующую неделю
                    datePickerItems.style.transform = 'translateX(0)'; // Возвращаем блок на место
                }, 300);
            } else {
                // Если свайп слишком короткий, возвращаем блок на исходную позицию
                datePickerItems.style.transition = 'transform 0.3s ease';
                datePickerItems.style.transform = 'translateX(0)';
            }
        });

    </script>

</div>
</body>
</html>