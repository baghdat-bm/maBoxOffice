{% extends "base.html" %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}Реестр билетов{% endblock %}

{% block header %}
    <link rel="stylesheet" href="{% static 'css/report.css' %}">    
{% endblock %}

{% block content %}
    <div class="container">
        <h3>Реестр билетов</h3>

        <!-- Форма фильтрации -->
        <form method="get" class="row g-3">
            {% if form.errors %}
                {% for field in form %}
                    {% if field.errors %}
                        {% for error in field.errors %}
                            <div class="alert alert-warning" role="alert">
                                {{ error }}
                            </div>
                        {% endfor %}
                    {% endif %}
                {% endfor %}
                {% if form.non_field_errors %}
                    {% for error in form.non_field_errors %}
                        <div class="alert alert-warning" role="alert">
                            {{ error }}
                        </div>
                    {% endfor %}
                {% endif %}
            {% endif %}
        
            <div class="row">
                <div class="col-md-3 mt-4">
                    <button type="submit" class="btn btn-primary">Сформировать отчет</button>
                </div>
                <!-- Фильтры даты всегда видимы -->
                <div class="col-md-3">
                    {{ form.start_date.label_tag }}
                    {{ form.start_date }}
                </div>
                <div class="col-md-3">
                    {{ form.end_date.label_tag }}
                    {{ form.end_date }}
                </div>
            </div>
        
            <!-- Кнопка для показа/скрытия дополнительных фильтров -->
            <div class="col-md-12">
                <button type="button" class="btn btn-secondary" id="showHideAdditionalFiltersButton" 
                        onclick="showHideAdditionalFilters(this)">
                    Показать дополнительные фильтры
                </button>
            </div>
        
            <!-- Скрываемые фильтры -->
            <div id="extraFilters" style="display: none;">
                <div class="col-md-3">
                    {{ form.order_number.label_tag }}
                    {{ form.order_number }}
                </div>
                <div class="col-md-3">
                    {{ form.ticket_number.label_tag }}
                    {{ form.ticket_number }}
                </div>
                <div class="col-md-6">
                    <label>Мероприятие</label>
                    <div>
                        <input type="checkbox" id="event_all" name="event_all" 
                               {% if 'all' in selected_events %}checked{% endif %}>
                        <label for="event_all">Все</label>
                    </div>
                    {% for event in events_list %}
                    <div>
                        <input type="checkbox" id="event_{{ event.id }}" name="event_templates" value="{{ event.id }}" 
                               {% if event in selected_events %}checked{% endif %}>
                        <label for="event_{{ event.id }}">{{ event.name }}</label>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </form>
    </div>

    <br>
    <div class="container">
        <table class="table table-striped">
            <thead class="table table-striped">
            <tr>
                <th>№</th>
                <th>№ билета</th>
                <th>№ заказа</th>
                <th>Дата и время сеанса</th>
                <th>Стоимость билета</th>
                <th>Наименование услуги</th>
                <th>Наименование инвентарья</th>
                <th>Тип продажи</th>
                <th>Дата и время брони</th>
                <th>Номер чек оплаты</th>
                <th>Номер телефона клиента</th>
                <th>Скачать билет</th>
            </tr>
            </thead>
            <tbody>
            {% for ticket in page_obj %}
                <tr>
                    <td>{{ forloop.counter }}</td>
                    <td>{{ ticket.ticket_number }}</td>
                    <td>{{ ticket.ticket_sale.id }}</td>
                    <td>{{ ticket.event_date }} {{ ticket.event_time }}</td>
                    <td>{{ ticket.amount }}</td>
                    <td>{{ ticket.service.name }}</td>
                    <td>{{ ticket.service.inventory.name }}</td>
                    <td>{{ ticket.ticket_sale.get_sale_type_display }}</td>
                    <td>
                        {% if ticket.ticket_sale.booking_begin_date %}
                            {{ ticket.ticket_sale.booking_begin_date }}
                        {% else %}
                            <!-- Если даты нет, выводим пустое поле -->
                        {% endif %}
                    </td>
                    <td>
                        {% if ticket.payment_id %}
                            {{ ticket.payment_id }}
                        {% else %}
                            <!-- Если платеж не найден, оставляем пустое поле -->
                        {% endif %}
                    </td>
                    {% if ticket.ticket_sale.phone %}
                        <td>{{ ticket.ticket_sale.phone }}</td>
                    {% else %}
                        <td></td>
                    {% endif %}
                    <td><a href="#" class="btn btn-outline-secondary">Скачать</a></td>
                </tr>
            {% empty %}
                <tr>
                    <td colspan="12">Нет данных для отображения.</td>
                </tr>
            {% endfor %}
            </tbody>
        </table>

        {% include 'reports/partials/paginator.html' %}

    </div>
{% endblock %}

{% block scripts %}
    <script src="{% static 'js/report.js' %}"></script>
    
    <script>
        window.onload = OnSessionsReportLoaded;
    </script>
{% endblock %}